var gpio = require('pi-gpio');
var piblaster = require('pi-blaster.js');

exports.turnRight = function (req, res) {
    writeHigh(22);
    writeLow(16);
    writeLow(11);
    writeHigh(12);
    //console.log('turning right');
    res.json(200, {message: 'success'});
}
exports.turnLeft = function (req, res) {
    writeHigh(16);
    writeLow(22);
    writeLow(12);
    writeHigh(11);
    //console.log('turning left');
    res.json(200, {message: 'success'});
}
exports.turnUp = function (req, res) {
    writeLow(16);
    writeHigh(22);
    writeLow(12);
    writeHigh(11);
    //console.log('turning up');
    res.json(200, {message: 'success'});
}
exports.turnDown = function (req, res) {
    writeLow(22);
    writeHigh(16);
    writeLow(11);
    writeHigh(12);
    //console.log('turning down');
    res.json(200, {message: 'success'});
}
exports.turnStop = function (req, res) {
    closePin(22);
    closePin(16);
    closePin(11);
    closePin(12);
    //console.log('turning stop');
    res.json(200, {message: 'success'});
}

exports.blink = function (req, res) {
    //blink(pin);
    res.json(200, {message: 'success'});

}

exports.blinkInterval = function (req, res) {
    //console.log('req interval=',req.params.interval);
    res.json(200, {message: 'success'});
}

function blink(pin, interval, blinkTime) {
    if (interval == undefined)
        interval = 900;

    if (blinkTime == undefined)
        blinkTime = 5;

    var i = 1;
    function myloop() {
        setTimeout(function () {

            if (i % 2 == 0) {
                writeHigh(pin);
            } else {
                writeLow(pin);
            }
            i++;
            if (i <= blinkTime * 2) {
                myloop();
            } else {
                closePin(pin)
            }
        }, interval);
    }
    myloop();
}

function writeHigh(pin) {
    console.log(pin + " high");
    gpio.close(pin);
    gpio.open(pin, "output", function (err) {
        gpio.write(pin, 1, function () {
            //gpio.close(pin); 
        });
    });
}

function writeLow(pin) {
    console.log(pin + " low");
    gpio.close(pin);
    gpio.open(pin, "output", function (err) {
        gpio.write(pin, 0, function () {
            //gpio.close(pin);
        });
    });
}

function closePin(pin) {
    console.log(pin + 'off');
    gpio.open(pin, "output", function (err) {
        gpio.write(pin, 0, function () {
            gpio.close(pin);
        });
    });
}


